<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Buscador por escuela</title>
  <style>
    :root {
      --bg:#0b1020; --card:#111834; --ink:#e8ebff; --muted:#9aa4d6; --accent:#6aa6ff; --danger:#ff6a6a;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans"; background:var(--bg); color:var(--ink)}
    .wrap{max-width:900px; margin:40px auto; padding:0 16px}
    .card{background:var(--card); border:1px solid rgba(255,255,255,.08); padding:20px; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{font-size:clamp(22px,3.5vw,34px); margin:0 0 10px}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin:18px 0}
    input[type="text"]{flex:1 1 280px; padding:14px 16px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0f1630; color:var(--ink); font-size:16px}
    button{padding:12px 16px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:var(--accent); color:#061026; font-weight:700; cursor:pointer}
    .hint{font-size:13px; color:var(--muted)}
    .result{margin-top:16px; padding:16px; border-radius:12px; background:#0f1734; border:1px dashed rgba(255,255,255,.15)}
    .big{font-size:22px; font-weight:800}
    table{width:100%; border-collapse:collapse; margin-top:10px}
    th, td{padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.08)}
    th{text-align:left; color:var(--muted); font-weight:600}
    .badge{display:inline-block; padding:.2rem .55rem; border-radius:999px; background:rgba(106,166,255,.18); color:#cfe1ff; border:1px solid rgba(106,166,255,.35); font-size:12px; font-weight:700}
    .err{color:var(--danger)}
    #status{display:none; margin-top:10px}
    #status.show{display:block}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Buscador por escuela</h1>

      <div class="row">
        <input id="q" type="text" placeholder="Escribí el nombre de la escuela" autocomplete="off" />
        <button id="btn">Buscar</button>
      </div>
      <div class="hint">Podés escribir parcialmente. Ignora mayúsculas/acentos.</div>

      <div id="status" class="hint"></div>
      <div id="out" class="result" hidden></div>
    </div>
  </div>

  <script>
  "use strict";
  const PUBLISHED_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS_4zkKxaJUS2idXU_ANJ7Yi7xiscy3IUoEVoCxiNEdFHc_VqVUpX8UTG_31wP49kgkmRyJyUetg6z9/pub?gid=1584081133&single=true&output=csv";

  const $ = sel => document.querySelector(sel);
  const status = (msg, type="") => {
    const el = $("#status");
    el.className = type ? `${type} hint show` : "hint";
    el.textContent = msg;
    if (msg) el.classList.add("show"); else el.classList.remove("show");
  };

  function normalize(str){
    return (str||"")
      .toString()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")       // quita acentos
      .replace(/[^\p{L}\p{N}\s\.\-]/gu, " ") // deja letras, números, espacios, punto y guión
      .replace(/\s+/g, " ")
      .trim()
      .toLowerCase();
  }

  function parseCSV(text){
    const rows = [];
    let cur = "", row = [], inQuotes = false;
    for (let i=0; i<text.length; i++){
      const c = text[i], n = text[i+1];
      if (c === '"'){
        if (inQuotes && n === '"'){ cur += '"'; i++; }
        else { inQuotes = !inQuotes; }
      } else if (c === ',' && !inQuotes){
        row.push(cur); cur = "";
      } else if ((c === '\n' || c === '\r') && !inQuotes){
        if (cur!=="" || row.length){ row.push(cur); rows.push(row); }
        row=[]; cur="";
        if (c === '\r' && n === '\n') i++; // saltear \n después de \r
      } else {
        cur += c;
      }
    }
    if (cur!=="" || row.length){ row.push(cur); rows.push(row); }
    return rows.filter(r=>r.length>0);
  }

  async function fetchData(){
    try{
      status("Cargando datos…");
      const res = await fetch(PUBLISHED_CSV_URL, { cache: "no-store" });
      if(!res.ok) throw new Error("No pude leer el CSV publicado");
      const csv = await res.text();
      const rows = parseCSV(csv);
      let start = 0;
      if (rows.length && rows[0].length >= 2){
        const h0 = rows[0][0]||"", h1 = rows[0][1]||"";
        if (/escuela/i.test(h0) || /zona/i.test(h1)) start = 1;
      }
      const body = rows.slice(start);
      const data = body.map(r => ({
        escuela: (r[0]||"").trim(),
        zona: (r[1]||"").trim()
      })).filter(r => r.escuela && r.zona);
      if (!data.length) throw new Error("No encontré datos válidos en el CSV.");
      status(`Datos listos: ${data.length} registros.`);
      return data;
    }catch(err){
      console.error(err);
      status("⚠️ Error cargando datos. Revisá que el enlace público siga activo.", "err");
      return [];
    }
  }

  function renderResult(matches, query){
    const out = $("#out");
    out.hidden = false;
    if(!matches.length){
      out.innerHTML = `<div class="err"><strong>Sin coincidencias</strong> para "${query}".</div>`;
      return;
    }
    const rows = matches.slice(0, 50).map(m => `<tr><td>${m.escuela}</td><td><span class="badge">${m.zona}</span></td></tr>`).join("");
    out.innerHTML = `
      <div><strong>${matches.length}</strong> resultado(s)</div>
      <table aria-label="Resultados">
        <thead><tr><th>Escuela</th><th>Zona</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
  }

  function makeSearcher(data){
    const idx = data.map(r => ({ ...r, key: normalize(r.escuela) }));
    return function search(q){
      const qn = normalize(q);
      if(!qn) return [];
      return idx.filter(r => r.key.includes(qn));
    }
  }

  let search = null;

  (async function init(){
    const data = await fetchData();
    if (!data.length){ return; }
    search = makeSearcher(data);
  })();

  function doSearch(){
    const q = $("#q").value;
    if(!search){ status("Todavía estoy cargando…"); return; }
    const matches = search(q);
    renderResult(matches, q);
  }

  $("#btn").addEventListener("click", doSearch);
  $("#q").addEventListener("keydown", e => { if(e.key === "Enter") doSearch(); });
  </script>
</body>
</html>
